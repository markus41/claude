# Eclipse Mosquitto MQTT Broker Configuration
# Production-ready configuration for Ahling Command Center
# Version: 2.0.x
# Documentation: https://mosquitto.org/man/mosquitto-conf-5.html

# ============================================================================
# General Configuration
# ============================================================================

# Daemon Configuration
pid_file /var/run/mosquitto/mosquitto.pid
user mosquitto

# Persistence
persistence true
persistence_location /mosquitto/data/
autosave_interval 300
autosave_on_changes false

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# Connection logging (disable in production for performance)
connection_messages true

# ============================================================================
# Network Configuration
# ============================================================================

# Default listener (MQTT)
listener 1883
protocol mqtt
socket_domain ipv4

# Maximum number of client connections
max_connections -1

# ============================================================================
# WebSocket Support
# ============================================================================

# WebSocket listener for browser-based clients
listener 9001
protocol websockets
socket_domain ipv4

# ============================================================================
# Security Configuration
# ============================================================================

# Authentication
allow_anonymous false
password_file /mosquitto/config/passwd

# Access Control List (optional)
# acl_file /mosquitto/config/acl

# ============================================================================
# Message Size & Queue Limits
# ============================================================================

# Maximum packet size (default 100MB, adjust as needed)
message_size_limit 104857600

# Maximum QoS (0, 1, or 2)
max_qos 2

# Maximum queued messages per client
max_queued_messages 1000

# Maximum queued bytes per client (0 = unlimited)
max_queued_bytes 0

# Persistent client expiration (seconds)
persistent_client_expiration 1m

# ============================================================================
# Performance Tuning
# ============================================================================

# Maximum inflight messages per client
max_inflight_messages 20

# Upgrade QoS (useful for bridging)
upgrade_outgoing_qos false

# ============================================================================
# Retained Messages
# ============================================================================

# Maximum number of retained messages (0 = unlimited)
max_retained_messages 0

# Retain available (true/false)
retain_available true

# ============================================================================
# Session Settings
# ============================================================================

# Set to true to immediately expire old sessions on client reconnect
# Set to false for better resilience
set_tcp_nodelay true

# ============================================================================
# Keep-Alive
# ============================================================================

# Maximum keep-alive time allowed by clients (seconds, 0 = unlimited)
max_keepalive 65535

# ============================================================================
# Publish Settings
# ============================================================================

# Allow clients to publish to $SYS topics (usually false)
sys_interval 10

# ============================================================================
# Bridge Configuration (Optional)
# ============================================================================
# Use this section to bridge to other MQTT brokers

# Example bridge to cloud MQTT
# connection bridge-to-cloud
# address mqtt.cloud-provider.com:8883
# topic homeassistant/# out 1
# topic cloud/# in 1
# remote_username cloud_user
# remote_password cloud_password
# bridge_cafile /mosquitto/config/ca.crt
# bridge_certfile /mosquitto/config/client.crt
# bridge_keyfile /mosquitto/config/client.key
# bridge_tls_version tlsv1.2
# bridge_insecure false
# try_private true
# start_type automatic
# restart_timeout 30

# ============================================================================
# TLS/SSL Configuration (Optional - Enable for production)
# ============================================================================
# Uncomment and configure for TLS support

# TLS listener on port 8883
# listener 8883
# protocol mqtt
# cafile /mosquitto/config/ca.crt
# certfile /mosquitto/config/server.crt
# keyfile /mosquitto/config/server.key
# tls_version tlsv1.2
# require_certificate false

# WebSocket TLS listener on port 9002
# listener 9002
# protocol websockets
# cafile /mosquitto/config/ca.crt
# certfile /mosquitto/config/server.crt
# keyfile /mosquitto/config/server.key
# tls_version tlsv1.2

# ============================================================================
# Additional Security Options
# ============================================================================

# Check for retained message limit
check_retain_source false

# Allow zero length client IDs (MQTT 3.1.1+)
allow_zero_length_clientid true

# Auto-assign client ID if not provided
auto_id_prefix auto-

# ============================================================================
# Plugin Configuration (Optional)
# ============================================================================
# plugin /usr/lib/mosquitto_dynamic_security.so
# plugin_opt_config_file /mosquitto/config/dynamic-security.json

# ============================================================================
# Statistics & Monitoring
# ============================================================================

# Publish statistics to $SYS topics
sys_interval 10

# ============================================================================
# Per-Listener Settings
# ============================================================================

# Maximum connections per listener
# per_listener_settings false

# ============================================================================
# Memory Management
# ============================================================================

# Memory limit (bytes, 0 = unlimited)
# Recommended: Set to ~80% of container memory limit
# memory_limit 0

# ============================================================================
# Client Requirements
# ============================================================================

# Require clients to provide client ID (MQTT 3.1 compatibility)
# allow_duplicate_messages false

# ============================================================================
# Optimization Flags
# ============================================================================

# Optimize for throughput vs latency
# queue_qos0_messages false

# ============================================================================
# Home Assistant Specific Settings
# ============================================================================

# Topics for Home Assistant integration
# Home Assistant uses: homeassistant/#
# Zigbee2MQTT uses: zigbee2mqtt/#
# Tasmota uses: tasmota/#

# ============================================================================
# Debugging (Disable in Production)
# ============================================================================

# Enable debug logging (very verbose)
# log_type debug
# log_type subscribe
# log_type unsubscribe
# log_type websockets
# log_type all

# ============================================================================
# End of Configuration
# ============================================================================
