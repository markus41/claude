# Container Workflow Settings

> **Project-Specific Configuration**
>
> Copy this file to your project: `.claude/container-workflow.local.md`
> Customize settings below for your container workflow.

---

## Project Information

- **Project Name**: my-app
- **Description**: Production containerized application
- **Maintainer**: devops-team@company.com
- **Repository**: https://github.com/your-org/my-app

---

## Registry Configuration

### Primary Registry
- **Type**: ghcr (GitHub Container Registry)
- **URL**: ghcr.io/your-org
- **Repository**: your-org/my-app
- **Authentication**: GITHUB_TOKEN environment variable
- **Auto-Push**: false (manual push required)

### Secondary Registry (Optional)
- **Type**: dockerhub
- **URL**: docker.io/your-org
- **Repository**: your-org/my-app-public
- **Use Case**: Public distribution

### Registry Behavior
- **Tag Latest on Main**: true
- **Prune Old Images**: keep last 10 versions
- **Multi-Registry Push**: false

---

## Security Scanning

### Scanner
- **Primary**: trivy
- **Version**: latest
- **Scan Trigger**: on-build, on-push, on-schedule (weekly)

### Severity Thresholds
- **Critical**: BLOCK (prevent deployment)
- **High**: WARN (report but allow with approval)
- **Medium**: REPORT (log only)
- **Low**: IGNORE

### Scan Configuration
```yaml
scan:
  os_packages: true
  language_deps: true
  config_files: true
  secrets: true

compliance:
  cis_docker: enabled
  custom_policies: ./policies/security.rego
```

---

## Versioning Strategy

### Strategy Type
- **Type**: semantic
- **Format**: v{major}.{minor}.{patch}
- **Example Tags**:
  - `v1.2.3` (release)
  - `v1.2.3-alpha.1` (pre-release)
  - `v1.2.3-rc.2` (release candidate)

### Auto-Tagging
- **Latest**: true (update on main branch)
- **Branch Tags**: true (feature-xyz, bugfix-abc)
- **Commit Tags**: true (main-abc123f)
- **Semantic Tags**: true (v1.2.3)

### Version Increment Rules
- **Main Branch**: auto-increment patch
- **Release Branch**: auto-increment minor
- **Breaking Changes**: require manual major increment

---

## Build Configuration

### Multi-Architecture
- **Enabled**: true
- **Platforms**:
  - linux/amd64 (x86_64)
  - linux/arm64 (Apple Silicon, AWS Graviton)
- **Builder**: docker buildx

### Build Settings
```yaml
build:
  context: .
  dockerfile: ./Dockerfile
  cache_from:
    - type=registry,ref=ghcr.io/your-org/my-app:buildcache
  cache_to:
    - type=registry,ref=ghcr.io/your-org/my-app:buildcache,mode=max

  build_args:
    NODE_ENV: production
    BUILD_DATE: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
    VCS_REF: $(git rev-parse --short HEAD)
    VERSION: $(git describe --tags --always)
```

### Required Files
- **Dockerfile**: ./Dockerfile
- **Dockerignore**: ./.dockerignore
- **Multi-Stage**: required

---

## Testing

### Container Tests
- **Framework**: docker-compose + pytest
- **Test File**: ./docker-compose.test.yml
- **Run on Build**: true
- **Coverage Required**: 80%

### Integration Tests
```yaml
integration:
  enabled: true
  services:
    - postgres:15-alpine
    - redis:7-alpine

  health_checks:
    - endpoint: /health
      expected: 200
      timeout: 30s

    - endpoint: /ready
      expected: 200
      timeout: 60s
```

### Smoke Tests
- **Production URL**: https://api.company.com/health
- **Expected Status**: 200
- **Run After Deploy**: true

---

## CI/CD Configuration

### Platform
- **Type**: github-actions
- **Workflow File**: ./.github/workflows/container.yml

### Pipeline Stages
```yaml
stages:
  validate:
    - lint-dockerfile (hadolint)
    - validate-compose
    - check-secrets

  build:
    - build-image
    - tag-image

  test:
    - unit-tests
    - integration-tests

  scan:
    - trivy-scan
    - cis-benchmark

  deploy:
    - push-to-registry (main branch only)
    - update-kubernetes (production requires approval)
```

### Branch Strategy
- **Main**: auto-deploy to staging, manual approval for production
- **Develop**: auto-deploy to dev environment
- **Feature/***: build and test only
- **Hotfix/***: fast-track to production with approval

---

## Deployment

### Kubernetes Deployment
```yaml
kubernetes:
  namespace: my-app-prod
  helm_chart: ./deployment/helm/my-app
  values: ./deployment/helm/values.yaml

  environments:
    dev:
      replicas: 2
      resources:
        requests: { cpu: 100m, memory: 256Mi }
        limits: { cpu: 500m, memory: 512Mi }

    staging:
      replicas: 3
      resources:
        requests: { cpu: 200m, memory: 512Mi }
        limits: { cpu: 1000m, memory: 1Gi }

    production:
      replicas: 5
      resources:
        requests: { cpu: 500m, memory: 1Gi }
        limits: { cpu: 2000m, memory: 2Gi }

      rollout: canary
      stages: [10%, 50%, 100%]
```

### Environment Configuration
- **Development**: Auto-deploy on commit
- **Staging**: Auto-deploy on merge to main
- **Production**: Manual approval + smoke tests

---

## Environment Variables

### Build-Time
```bash
# Registry
DOCKER_REGISTRY=ghcr.io/your-org
IMAGE_NAME=my-app

# Versioning
VERSION_STRATEGY=semantic
GIT_TAG=$(git describe --tags --always)

# Build
DOCKER_BUILDKIT=1
BUILDKIT_PROGRESS=plain
```

### Runtime (Secrets - Use Vault/K8s Secrets)
```bash
# DO NOT COMMIT THESE - Use secrets management
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
API_KEY=***

# Non-sensitive
NODE_ENV=production
LOG_LEVEL=info
PORT=3000
```

---

## Hooks & Automation

### Pre-Build Hooks
- ✅ Validate Dockerfile best practices
- ✅ Check for hardcoded secrets
- ✅ Verify .dockerignore exists
- ✅ Lint docker-compose files

### Post-Build Hooks
- ✅ Run security scans
- ✅ Generate SBOM (Software Bill of Materials)
- ✅ Update documentation
- ✅ Notify team on Slack

### Post-Deploy Hooks
- ✅ Run smoke tests
- ✅ Verify health endpoints
- ✅ Update monitoring dashboards
- ✅ Create changelog entry

---

## Monitoring & Observability

### Metrics
```yaml
metrics:
  enabled: true
  port: 9090
  path: /metrics
  format: prometheus
```

### Logging
```yaml
logging:
  level: info
  format: json
  destination: stdout

  aggregation:
    - datadog
    - cloudwatch
```

### Tracing
```yaml
tracing:
  enabled: true
  provider: opentelemetry
  sampling_rate: 0.1
  exporter: jaeger
```

---

## Resource Limits

### Development
- **CPU**: 100m - 500m
- **Memory**: 256Mi - 512Mi
- **Storage**: 5Gi

### Staging
- **CPU**: 200m - 1000m
- **Memory**: 512Mi - 1Gi
- **Storage**: 10Gi

### Production
- **CPU**: 500m - 2000m
- **Memory**: 1Gi - 2Gi
- **Storage**: 50Gi
- **Auto-Scaling**: Enabled (min: 3, max: 10)

---

## Compliance & Governance

### Security Standards
- **CIS Docker Benchmark**: Level 1
- **CIS Kubernetes Benchmark**: Level 1
- **OWASP Container Security**: Enforced

### Audit Requirements
- **Image Signing**: Required (cosign)
- **SBOM Generation**: Required
- **Vulnerability Database**: Updated daily
- **Audit Logs**: Retained 90 days

### Policies
```rego
# Custom OPA policies
package container.security

deny[msg] {
  input.User == "root"
  msg = "Containers must not run as root"
}

deny[msg] {
  not input.HealthCheck
  msg = "HEALTHCHECK instruction required"
}
```

---

## Notifications

### Slack Integration
```yaml
notifications:
  slack:
    webhook: ${SLACK_WEBHOOK_URL}
    channels:
      build: #container-builds
      security: #security-alerts
      deploy: #deployments
```

### Email Alerts
- **Build Failures**: devops-team@company.com
- **Security Alerts**: security-team@company.com
- **Production Deploys**: engineering-leads@company.com

---

## Troubleshooting

### Common Issues

#### Registry Authentication
```bash
# GitHub
echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_USER --password-stdin

# AWS ECR
aws ecr get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin 123456789.dkr.ecr.us-east-1.amazonaws.com
```

#### Build Cache
```bash
# Clear cache
docker builder prune -a -f

# No-cache build
docker build --no-cache -t my-app .
```

#### Image Size
```bash
# Analyze layers
docker history my-app:latest

# Use dive for inspection
dive my-app:latest
```

---

## Quick Reference

### Build & Push
```bash
# Build
docker build -t ghcr.io/your-org/my-app:v1.2.3 .

# Scan
trivy image ghcr.io/your-org/my-app:v1.2.3

# Push
docker push ghcr.io/your-org/my-app:v1.2.3
```

### Deploy to Kubernetes
```bash
# Update image
kubectl set image deployment/my-app \
  my-app=ghcr.io/your-org/my-app:v1.2.3 \
  -n my-app-prod

# Or use Helm
helm upgrade my-app ./deployment/helm/my-app \
  --set image.tag=v1.2.3 \
  -n my-app-prod
```

---

## Notes

- This file is gitignored by default (`.claude/*.local.md`)
- Use environment variables for secrets, never commit them
- Update this file when deployment strategy changes
- Review settings quarterly for security updates

---

**Last Updated**: 2025-12-13
**Configuration Version**: 1.0.0
**Team**: DevOps Engineering
