# Agent Teams Integration for Jira Orchestrator
# Maps Jira workflows, issue types, and phases to AutoGen-style agent teams
# Reference: .claude/registry/teams.index.json

version: "1.0.0"
description: "Team activation rules for Jira orchestration workflows"

# Team Registry Reference
teams_registry: ".claude/registry/teams.index.json"

# Phase-to-Team Mapping
# Maps 6-phase protocol to appropriate teams
phase_teams:
  EXPLORE:
    primary: "documentation-guild"  # DOCS-1: Surveyor, Archivist analyze codebase
    secondary: "debug-squadron"     # DEBUG-1: Sleuth for investigation
    triggers:
      - "analyze"
      - "investigate"
      - "understand"
      - "research"

  PLAN:
    primary: "code-strike"          # STRIKE-1: Blueprint for architecture
    secondary: "atlassian-ops"      # JIRA-1: Divider for epic decomposition
    triggers:
      - "design"
      - "architect"
      - "plan"
      - "strategy"

  CODE:
    primary: "code-strike"          # STRIKE-1: Genesis leads implementation
    fallback_teams:
      frontend: "frontend-forge"    # UI-1: For frontend-heavy work
      mobile: "mobile-force"        # MOBILE-1: For mobile work
      backend: "data-pipeline"      # DATA-1: For data/backend work
      auth: "identity-vault"        # AUTH-1: For authentication work
      messaging: "messaging-hub"    # MSG-1: For event-driven work
    triggers:
      - "implement"
      - "build"
      - "create"
      - "develop"

  TEST:
    primary: "quality-council"      # COUNCIL-Q: Comprehensive QA
    secondary: "debug-squadron"     # DEBUG-1: For test failures
    triggers:
      - "test"
      - "validate"
      - "verify"
      - "coverage"

  FIX:
    primary: "debug-squadron"       # DEBUG-1: Sleuth leads debugging
    secondary: "code-strike"        # STRIKE-1: For implementing fixes
    triggers:
      - "fix"
      - "debug"
      - "resolve"
      - "patch"

  DOCUMENT:
    primary: "documentation-guild"  # DOCS-1: Full documentation
    secondary: "atlassian-ops"      # JIRA-1: Confluence integration
    triggers:
      - "document"
      - "write"
      - "update docs"
      - "confluence"

# Issue Type Mappings
# Activates specific teams based on Jira issue type
issue_type_teams:
  Initiative:
    primary: "atlassian-ops"        # JIRA-1: High-level portfolio planning
    pattern: "swarm"
    description: "Strategic initiatives spanning multiple epics"
    phases:
      EXPLORE: ["documentation-guild", "atlassian-ops"]
      PLAN: ["atlassian-ops", "code-strike"]
      CODE: ["code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Epic:
    primary: "atlassian-ops"        # JIRA-1: Epic decomposition
    pattern: "swarm"
    description: "Large features broken into stories"
    phases:
      EXPLORE: ["documentation-guild", "atlassian-ops"]
      PLAN: ["atlassian-ops", "code-strike"]
      CODE: ["code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Story:
    primary: "code-strike"          # STRIKE-1: Feature development
    pattern: "hierarchical"
    description: "User-facing features with acceptance criteria"
    phases:
      EXPLORE: ["documentation-guild", "code-strike"]
      PLAN: ["code-strike"]
      CODE: ["code-strike"]  # + domain-specific teams
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Task:
    primary: "code-strike"          # STRIKE-1: Technical tasks
    pattern: "hierarchical"
    description: "Technical work items"
    phases:
      EXPLORE: ["documentation-guild"]
      PLAN: ["code-strike"]
      CODE: ["code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Sub-task:
    primary: "code-strike"          # STRIKE-1: Granular work items
    pattern: "pipeline"
    description: "Granular tasks under stories/tasks"
    inherit_parent_teams: true      # Use parent issue's team assignments
    phases:
      EXPLORE: ["code-strike"]
      PLAN: ["code-strike"]
      CODE: ["code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Bug:
    primary: "debug-squadron"       # DEBUG-1: Specialized for bugs
    pattern: "pipeline"
    description: "Defects and issues requiring fixes"
    phases:
      EXPLORE: ["debug-squadron"]
      PLAN: ["debug-squadron"]
      CODE: ["debug-squadron", "code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Spike:
    primary: "documentation-guild"  # DOCS-1: Research and exploration
    pattern: "broadcast"
    description: "Research and technical investigation"
    phases:
      EXPLORE: ["documentation-guild", "code-strike"]
      PLAN: ["code-strike"]
      CODE: ["code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Technical-Debt:
    primary: "migration-convoy"     # MIGRATE-1: Refactoring expertise
    pattern: "pipeline"
    description: "Refactoring and code improvement"
    phases:
      EXPLORE: ["documentation-guild", "migration-convoy"]
      PLAN: ["migration-convoy", "code-strike"]
      CODE: ["migration-convoy", "code-strike"]
      TEST: ["quality-council"]
      FIX: ["debug-squadron"]
      DOCUMENT: ["documentation-guild"]

  Security:
    primary: "security-tribunal"    # SEC-1: Security-focused work
    pattern: "debate"
    description: "Security vulnerabilities and hardening"
    phases:
      EXPLORE: ["security-tribunal"]
      PLAN: ["security-tribunal", "code-strike"]
      CODE: ["security-tribunal", "code-strike"]
      TEST: ["security-tribunal", "quality-council"]
      FIX: ["security-tribunal", "debug-squadron"]
      DOCUMENT: ["security-tribunal", "documentation-guild"]

# Label-Based Team Activation
# Activates teams based on Jira labels
label_teams:
  # Domain Labels
  "domain:frontend":
    teams: ["frontend-forge"]
    priority: "high"

  "domain:backend":
    teams: ["code-strike", "data-pipeline"]
    priority: "high"

  "domain:database":
    teams: ["data-pipeline"]
    priority: "high"

  "domain:testing":
    teams: ["quality-council"]
    priority: "high"

  "domain:devops":
    teams: ["ship-crew"]
    priority: "high"

  "domain:security":
    teams: ["security-tribunal"]
    priority: "critical"

  "domain:api":
    teams: ["code-strike"]
    priority: "high"

  "domain:docs":
    teams: ["documentation-guild"]
    priority: "medium"

  # Technology Labels
  "tech:react":
    teams: ["frontend-forge"]
    priority: "high"

  "tech:mobile":
    teams: ["mobile-force"]
    priority: "high"

  "tech:keycloak":
    teams: ["identity-vault"]
    priority: "high"

  "tech:kafka":
    teams: ["messaging-hub"]
    priority: "high"

  "tech:kubernetes":
    teams: ["ship-crew"]
    priority: "high"

  "tech:mongodb":
    teams: ["data-pipeline"]
    priority: "high"

  # Process Labels
  "needs:review":
    teams: ["pr-review-panel", "quality-council"]
    priority: "high"

  "needs:security-review":
    teams: ["security-tribunal"]
    priority: "critical"

  "needs:docs":
    teams: ["documentation-guild"]
    priority: "medium"

# Component-Based Team Activation
# Maps Jira components to teams
component_teams:
  "Frontend":
    teams: ["frontend-forge"]

  "Backend":
    teams: ["code-strike", "data-pipeline"]

  "API":
    teams: ["code-strike"]

  "Database":
    teams: ["data-pipeline"]

  "Authentication":
    teams: ["identity-vault"]

  "Infrastructure":
    teams: ["ship-crew"]

  "Mobile":
    teams: ["mobile-force"]

  "Security":
    teams: ["security-tribunal"]

  "Documentation":
    teams: ["documentation-guild"]

# Workflow Stage Teams
# Teams for specific Jira workflow transitions
workflow_teams:
  "To Do -> In Progress":
    activate: ["code-strike"]
    notification: "Team STRIKE-1 activated for development"

  "In Progress -> Code Review":
    activate: ["pr-review-panel", "quality-council"]
    notification: "Teams REVIEW-1 and COUNCIL-Q activated for review"

  "Code Review -> QA":
    activate: ["quality-council"]
    notification: "Team COUNCIL-Q activated for QA"

  "QA -> Done":
    activate: ["documentation-guild", "ship-crew"]
    notification: "Teams DOCS-1 and SHIP-1 activated for completion"

  "* -> Blocked":
    activate: ["debug-squadron"]
    notification: "Team DEBUG-1 activated for blockers"

# PR Review Teams
# Teams activated for pull request workflows
pr_teams:
  create:
    teams: ["pr-review-panel"]
    lead: "Inquisitor"

  review_requested:
    teams: ["pr-review-panel", "quality-council"]
    lead: "Inquisitor"

  changes_requested:
    teams: ["debug-squadron", "code-strike"]
    lead: "Sleuth"

  approved:
    teams: ["ship-crew"]
    lead: "Launcher"

  merged:
    teams: ["documentation-guild"]
    lead: "Archivist"

# Confluence Documentation Teams
confluence_teams:
  "Technical Design":
    team: "code-strike"
    lead: "Blueprint"

  "Implementation Notes":
    team: "code-strike"
    lead: "Genesis"

  "Test Plan & Results":
    team: "quality-council"
    lead: "Paramount"

  "Runbook":
    team: "ship-crew"
    lead: "Launcher"

  "Security Review":
    team: "security-tribunal"
    lead: "Bastion"

# Team Activation Rules
activation_rules:
  # Minimum agents from team to activate
  min_agents: 3

  # Maximum teams active simultaneously
  max_concurrent_teams: 3

  # Team priority when multiple match
  priority_order:
    - "security-tribunal"   # Security always first
    - "debug-squadron"      # Bugs/issues high priority
    - "quality-council"     # Quality gates
    - "code-strike"         # Development
    - "pr-review-panel"     # Reviews
    - "ship-crew"           # Deployment
    - "documentation-guild" # Documentation
    - "frontend-forge"      # Domain-specific
    - "mobile-force"
    - "data-pipeline"
    - "identity-vault"
    - "messaging-hub"
    - "atlassian-ops"
    - "growth-squad"
    - "migration-convoy"
    - "multi-tenant-architects"

  # Auto-deactivate teams after phase completion
  auto_deactivate: true

  # Handoff between teams
  handoff_protocol: "checkpoint"  # checkpoint, immediate, queued

# Team Communication
team_communication:
  # How teams report progress
  reporting:
    channel: "jira-comment"
    frequency: "phase-complete"
    include_confluence_links: true

  # Inter-team coordination
  coordination:
    method: "lead-to-lead"
    checkpoint_sync: true

# Metrics & Tracking
metrics:
  track_team_usage: true
  track_phase_duration: true
  track_team_effectiveness: true
  report_to: "confluence"
  dashboard_page: "Team Performance Dashboard"

# Parent-Child Issue Orchestration
# Handles Task with Sub-tasks, Story with Tasks, Epic with Stories
parent_child_orchestration:
  # Enable parent-child detection and handling
  enabled: true

  # Hierarchy definitions
  hierarchy:
    Initiative:
      children: ["Epic"]
      orchestration_pattern: "cascade"
    Epic:
      children: ["Story", "Task", "Bug"]
      orchestration_pattern: "cascade"
    Story:
      children: ["Sub-task", "Task"]
      orchestration_pattern: "parallel"
    Task:
      children: ["Sub-task"]
      orchestration_pattern: "parallel"

  # Team inheritance rules
  inheritance:
    # How child issues inherit team assignments
    strategy: "merge"  # merge, override, inherit_primary

    # What to inherit from parent
    inherit_from_parent:
      - primary_team
      - domain_teams      # From labels like domain:frontend
      - technology_teams  # From labels like tech:react
      - component_teams

    # Child can override these
    child_can_override:
      - phase_teams
      - secondary_teams

    # Always use parent's team for these
    force_parent_teams:
      - security_context   # Security team from parent always applies
      - review_teams       # PR review inherits parent context

  # Parallel Sub-task Execution
  parallel_subtasks:
    enabled: true
    max_concurrent: 5

    # How to distribute work
    distribution:
      strategy: "domain_affinity"  # domain_affinity, round_robin, load_balanced

      # Domain affinity rules - route subtasks to specialized teams
      affinity_rules:
        - pattern: ".*frontend.*|.*UI.*|.*component.*"
          team: "frontend-forge"
        - pattern: ".*backend.*|.*API.*|.*service.*"
          team: "code-strike"
        - pattern: ".*test.*|.*spec.*|.*coverage.*"
          team: "quality-council"
        - pattern: ".*database.*|.*migration.*|.*schema.*"
          team: "data-pipeline"
        - pattern: ".*auth.*|.*login.*|.*permission.*"
          team: "identity-vault"
        - pattern: ".*deploy.*|.*infra.*|.*k8s.*"
          team: "ship-crew"
        - pattern: ".*doc.*|.*readme.*|.*confluence.*"
          team: "documentation-guild"

    # Synchronization points
    sync_points:
      - after_explore: true    # Sync after all subtasks complete EXPLORE
      - after_code: true       # Sync after all subtasks complete CODE
      - before_test: true      # Sync before parent TEST phase
      - after_fix: true        # Sync fixes before final review

    # Dependency handling
    dependencies:
      respect_jira_links: true   # Honor Jira "blocks" relationships
      auto_sequence: false       # Auto-detect dependencies from code
      block_on_failure: true     # Block dependent subtasks on failure

  # Parent Task Coordination
  parent_coordination:
    # Parent task role during subtask execution
    parent_role: "coordinator"  # coordinator, participant, observer

    # Teams for parent coordination
    coordinator_teams:
      primary: "atlassian-ops"   # JIRA-1: Divider manages decomposition
      support: "code-strike"     # STRIKE-1: Blueprint for architecture

    # Parent responsibilities
    responsibilities:
      - monitor_subtask_progress
      - resolve_blockers
      - merge_subtask_results
      - quality_gate_enforcement
      - status_aggregation

    # Status propagation rules
    status_propagation:
      # When all subtasks complete, update parent
      all_complete: "mark_parent_ready_for_review"
      # When any subtask fails, update parent
      any_failed: "mark_parent_blocked"
      # When any subtask blocked, notify parent
      any_blocked: "escalate_to_parent_team"

    # Aggregation rules
    aggregation:
      # How to combine subtask outputs
      code_changes: "merge_to_parent_branch"
      test_results: "aggregate_coverage"
      documentation: "compile_to_parent_page"

  # Phase Coordination for Parent-Child
  phase_coordination:
    EXPLORE:
      parent_action: "decompose_and_assign"
      subtask_action: "analyze_assigned_scope"
      teams:
        parent: ["atlassian-ops", "documentation-guild"]
        subtask: "inherit"  # Inherits from parent
      sync_required: true

    PLAN:
      parent_action: "review_subtask_plans"
      subtask_action: "plan_implementation"
      teams:
        parent: ["atlassian-ops"]
        subtask: ["code-strike"]
      sync_required: true

    CODE:
      parent_action: "monitor_and_unblock"
      subtask_action: "implement"
      teams:
        parent: ["atlassian-ops"]
        subtask: "domain_affinity"  # Based on subtask content
      sync_required: false  # Parallel execution
      parallel_allowed: true

    TEST:
      parent_action: "aggregate_results"
      subtask_action: "test_scope"
      teams:
        parent: ["quality-council"]
        subtask: ["quality-council"]
      sync_required: true  # Wait for all tests

    FIX:
      parent_action: "coordinate_fixes"
      subtask_action: "fix_assigned"
      teams:
        parent: ["debug-squadron"]
        subtask: ["debug-squadron", "code-strike"]
      sync_required: false
      parallel_allowed: true

    DOCUMENT:
      parent_action: "compile_documentation"
      subtask_action: "document_scope"
      teams:
        parent: ["documentation-guild", "atlassian-ops"]
        subtask: ["documentation-guild"]
      sync_required: true

  # Subtask Creation Rules
  subtask_creation:
    # When parent detects need for subtasks
    auto_create: false  # Manual or via /jira:prepare

    # Template for new subtasks
    template:
      inherit_labels: true
      inherit_components: true
      inherit_sprint: true
      add_labels:
        - "auto-created"
        - "parent:${PARENT_KEY}"

    # Team assignment for new subtasks
    team_assignment:
      strategy: "domain_detection"  # Analyze subtask summary for domain
      fallback: "parent_primary"    # Use parent's primary team

  # Completion Criteria
  completion:
    # Parent can only complete when:
    require_all_subtasks_done: true
    require_all_tests_pass: true
    require_documentation: true

    # Automatic status transitions
    auto_transitions:
      all_subtasks_in_review: "parent_to_review"
      all_subtasks_done: "parent_to_qa"
      qa_passed: "parent_to_done"

# Example Usage for Task with Subtasks
#
# 1. On /jira:work TASK-123 (has 3 subtasks):
#    - Detect parent-child relationship
#    - Load parent context (labels, components, teams)
#    - Identify subtasks: TASK-123-1, TASK-123-2, TASK-123-3
#
# 2. EXPLORE Phase:
#    - Parent Team (JIRA-1): Analyze full scope
#    - Assign subtasks to teams based on domain affinity
#    - TASK-123-1 (frontend) -> UI-1
#    - TASK-123-2 (backend) -> STRIKE-1
#    - TASK-123-3 (tests) -> COUNCIL-Q
#
# 3. CODE Phase (Parallel):
#    - Launch parallel agents for each subtask
#    - UI-1 works on TASK-123-1
#    - STRIKE-1 works on TASK-123-2
#    - COUNCIL-Q prepares test scaffolding for TASK-123-3
#    - Parent coordinator (JIRA-1) monitors progress
#
# 4. Sync Point (after CODE):
#    - Aggregate changes from all subtasks
#    - Merge to parent branch
#    - Run integration tests
#
# 5. TEST Phase:
#    - COUNCIL-Q runs full test suite
#    - Includes tests from all subtasks
#    - Report to parent issue
#
# 6. Completion:
#    - All subtasks marked Done
#    - Parent automatically transitions to Done
#    - Documentation compiled to Confluence
