# Approval Workflow System Configuration
# Version: 1.0.0
# Last Updated: 2025-12-22

# Global Approval Settings
global:
  enabled: true
  default_timeout_hours: 24
  auto_escalation: true
  audit_trail: true
  notification_channels:
    - slack
    - email
    - jira

  # Risk-based auto-approval
  auto_approval:
    enabled: true
    max_risk_score: 30  # Auto-approve if risk <= 30
    conditions:
      - "code_coverage >= 80"
      - "security_scan == 'passed'"
      - "no_breaking_changes == true"

# Approval Workflows
workflows:
  # Standard Pull Request Approval
  standard_pr_approval:
    name: "Standard Pull Request Approval"
    version: "1.0.0"
    enabled: true

    applies_to:
      type: "pull_request"
      target_branches:
        - "main"
        - "develop"
      exclude_branches:
        - "hotfix_*"
        - "emergency_*"

    levels:
      - level: 1
        name: "Peer Review"
        type: "parallel"
        approvers:
          - role: "team_lead"
            count: 1
          - role: "senior_engineer"
            count: 1
            conditions:
              - "files_changed > 50"
        quorum: 1
        timeout_hours: 24

        notifications:
          slack:
            channel: "#engineering"
            mention_approvers: true
          email: true
          jira: true

        escalation:
          enabled: true
          timeout_hours: 24
          escalate_to: "engineering_manager"
          auto_approve_after_hours: 48
          auto_approve_conditions:
            - "risk_level == 'low'"

    policies:
      - "code_quality_gate"
      - "security_scan_required"

  # Production Pull Request Approval
  production_pr_approval:
    name: "Production Pull Request Approval"
    version: "1.0.0"
    enabled: true

    applies_to:
      type: "pull_request"
      target_branches:
        - "production"
        - "main"
      conditions:
        - "deployment_target == 'production'"

    levels:
      - level: 1
        name: "Technical Review"
        type: "parallel"
        approvers:
          - role: "backend_lead"
            count: 1
            conditions:
              - "backend_files_changed == true"
          - role: "frontend_lead"
            count: 1
            conditions:
              - "frontend_files_changed == true"
        quorum: 1
        timeout_hours: 24

      - level: 2
        name: "Security Review"
        type: "sequential"
        approvers:
          - team: "security_team"
            count: 1
        timeout_hours: 12
        skip_conditions:
          - "security_scan == 'passed'"
          - "security_files_changed == false"

      - level: 3
        name: "Management Approval"
        type: "sequential"
        approvers:
          - role: "engineering_manager"
            count: 1
        timeout_hours: 48
        required_conditions:
          - "risk_level == 'high' OR risk_level == 'critical'"
          - "financial_impact > 50000"

    policies:
      - "production_quality_gate"
      - "security_scan_strict"
      - "review_requirements_strict"

  # Production Deployment Approval
  production_deployment:
    name: "Production Deployment Approval"
    version: "1.0.0"
    enabled: true

    applies_to:
      type: "deployment"
      environments:
        - "production"

    levels:
      - level: 1
        name: "Engineering Approval"
        type: "sequential"
        approvers:
          - role: "engineering_manager"
            count: 1
        timeout_hours: 24

      - level: 2
        name: "Security Approval"
        type: "sequential"
        approvers:
          - team: "security_team"
            count: 1
        timeout_hours: 12

      - level: 3
        name: "Executive Approval"
        type: "sequential"
        approvers:
          - role: "cto"
            count: 1
        timeout_hours: 48
        required_conditions:
          - "deployment_size == 'major'"
          - "breaking_changes == true"

    gates:
      pre_deployment:
        - "all_tests_passed"
        - "security_scan_passed"
        - "staging_validation_complete"

      post_deployment:
        - "smoke_tests_passed"
        - "monitoring_healthy"

    escalation:
      enabled: true
      levels:
        - delay_hours: 24
          action: "remind"
          notify: "original_approvers"

        - delay_hours: 48
          action: "escalate"
          escalate_to: "vp_engineering"

        - delay_hours: 72
          action: "page"
          escalate_to: "cto"

  # Hotfix Approval (Expedited)
  hotfix_approval:
    name: "Hotfix Approval (Expedited)"
    version: "1.0.0"
    enabled: true

    applies_to:
      type: "pull_request"
      branches:
        - "hotfix_*"
        - "emergency_*"
      labels:
        - "hotfix"
        - "emergency"

    levels:
      - level: 1
        name: "On-Call Review"
        type: "parallel"
        approvers:
          - role: "oncall_engineer"
            count: 1
        timeout_hours: 2

        post_merge_review:
          enabled: true
          reviewers:
            - "engineering_manager"
            - "security_team"
          deadline_hours: 24

    escalation:
      enabled: true
      timeout_hours: 2
      escalate_to: "engineering_director"
      page: true

  # Release Approval
  release_approval:
    name: "Release Approval"
    version: "1.0.0"
    enabled: true

    applies_to:
      type: "release"
      environments:
        - "production"

    levels:
      - level: 1
        name: "Engineering Sign-Off"
        type: "sequential"
        approvers:
          - role: "engineering_manager"
            count: 1
        timeout_hours: 48

      - level: 2
        name: "Product Sign-Off"
        type: "sequential"
        approvers:
          - role: "product_manager"
            count: 1
        timeout_hours: 48

      - level: 3
        name: "Compliance Review"
        type: "parallel"
        approvers:
          - team: "security_team"
            count: 1
          - team: "compliance_team"
            count: 1
        quorum: 2
        timeout_hours: 72

      - level: 4
        name: "Executive Approval"
        type: "sequential"
        approvers:
          - role: "cto"
            count: 1
        timeout_hours: 96
        required_conditions:
          - "release_type == 'major'"

    compliance_checks:
      - "soc2_requirements"
      - "gdpr_requirements"
      - "iso27001_requirements"

# Approval Gates
gates:
  # Pre-PR Gates
  pre_pr_gate:
    name: "Pre-PR Creation Gate"
    required_checks:
      - name: "branch_up_to_date"
        type: "git"
        blocking: true

      - name: "local_tests_passing"
        type: "test"
        blocking: false

  # Pre-Merge Gates
  pre_merge_gate:
    name: "Pre-Merge Gate"
    required_checks:
      - name: "ci_tests"
        type: "external"
        provider: "github_actions"
        required_status: "success"
        blocking: true

      - name: "code_quality"
        type: "policy"
        policy: "code_quality_gate"
        blocking: true

      - name: "security_scan"
        type: "policy"
        policy: "security_gate"
        blocking: true

      - name: "approval_workflow"
        type: "approval"
        workflow: "standard_pr_approval"
        blocking: true

  # Pre-Deploy Gates
  pre_deploy_gate:
    name: "Pre-Deployment Gate"
    required_checks:
      - name: "staging_validation"
        type: "external"
        blocking: true

      - name: "security_scan"
        type: "policy"
        policy: "security_gate_strict"
        blocking: true

      - name: "deployment_approval"
        type: "approval"
        workflow: "production_deployment"
        blocking: true

      - name: "rollback_plan"
        type: "documentation"
        blocking: true

# Delegation Rules
delegation:
  enabled: true

  rules:
    # Manager delegation during vacation
    - name: "vacation_delegation"
      from_role: "engineering_manager"
      to_role: "senior_engineer"
      auto_assign: false
      require_setup: true
      max_duration_days: 30
      scope:
        - "pull_request_approval"
        - "deployment_approval"
      exclude:
        - "release_approval"
        - "compliance_approval"

    # On-call rotation
    - name: "oncall_rotation"
      from_role: "oncall_engineer"
      to_schedule: "pagerduty_oncall"
      auto_assign: true
      scope:
        - "hotfix_approval"
        - "emergency_approval"

    # Team proxy
    - name: "team_lead_proxy"
      from_role: "team_lead"
      to_team: "senior_engineers"
      quorum: 1
      scope:
        - "pull_request_approval"

# Escalation Rules
escalation:
  global:
    enabled: true
    default_levels:
      - level: 1
        delay_hours: 24
        action: "remind"

      - level: 2
        delay_hours: 48
        action: "escalate"
        escalate_to: "manager"

      - level: 3
        delay_hours: 72
        action: "escalate"
        escalate_to: "director"

  critical:
    # Faster escalation for critical items
    levels:
      - level: 1
        delay_hours: 4
        action: "escalate"
        escalate_to: "manager"

      - level: 2
        delay_hours: 8
        action: "page"
        escalate_to: "director"

# Notification Templates
notifications:
  slack:
    approval_request:
      template: "approval_request_slack"
      mentions: true
      buttons: true

    approval_decision:
      template: "approval_decision_slack"
      thread_reply: true

    escalation:
      template: "escalation_slack"
      priority: "high"

  email:
    approval_request:
      template: "approval_request_email"
      priority: "normal"

    escalation:
      template: "escalation_email"
      priority: "high"

# Audit Configuration
audit:
  enabled: true
  storage_path: "/home/user/claude/jira-orchestrator/sessions/approvals"
  retention_days: 2555  # 7 years for SOC2
  immutable: true
  digital_signature: true

  compliance_frameworks:
    - "SOC2"
    - "ISO27001"
    - "GDPR"

  audit_events:
    - "approval_requested"
    - "approval_granted"
    - "approval_rejected"
    - "approval_delegated"
    - "approval_escalated"
    - "approval_timeout"
    - "approval_auto_approved"

# Compliance Requirements
compliance:
  soc2:
    controls:
      - "CC6.1"  # Logical Access
      - "CC8.1"  # Change Management
      - "CC7.2"  # System Monitoring

    evidence_collection:
      enabled: true
      frequency: "continuous"

  gdpr:
    controls:
      - "Art32"  # Security of Processing

    data_retention:
      approval_records: "7_years"
      personal_data: "as_required"

  iso27001:
    controls:
      - "A.9.2.1"  # User Registration
      - "A.12.1.2"  # Change Management
