// ============================================================================
// JIRA ORCHESTRATOR - PRISMA SCHEMA
// ============================================================================
// Database: Neon PostgreSQL
// Generated: 2025-01-19
// Version: 7.5.0
// ============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("NEON_DIRECT_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

/// Orchestration - Represents a single /jira-work session
model Orchestration {
  id            String   @id @default(cuid())
  issueKey      String   @map("issue_key")
  projectKey    String   @map("project_key")
  currentPhase  Phase    @default(EXPLORE) @map("current_phase")
  status        Status   @default(ACTIVE)

  // Timing
  startedAt     DateTime @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")
  durationMs    Int?     @map("duration_ms")

  // User context
  createdBy     String?  @map("created_by")
  assignedTo    String?  @map("assigned_to")

  // Workflow tracking
  workflowId    String?  @map("workflow_id")  // Temporal workflow ID
  sessionId     String?  @map("session_id")   // Claude session ID

  // Metadata
  metadata      Json?

  // Relations
  events        Event[]
  checkpoints   Checkpoint[]
  agents        AgentExecution[]
  metrics       OrchestrationMetric[]
  notifications Notification[]
  approvals     Approval[]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([issueKey, startedAt])
  @@index([issueKey])
  @@index([projectKey])
  @@index([status])
  @@index([currentPhase])
  @@index([startedAt])
  @@map("orchestrations")
}

/// Event - Event sourcing store for orchestration events
model Event {
  id              String   @id @default(cuid())
  orchestrationId String   @map("orchestration_id")
  orchestration   Orchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  eventType       String   @map("event_type")
  sequenceNumber  Int      @default(autoincrement()) @map("sequence_number")
  timestamp       DateTime @default(now())

  // Actor context
  agentName       String?  @map("agent_name")
  actorId         String?  @map("actor_id")
  actorEmail      String?  @map("actor_email")

  // Event data
  phase           Phase?
  payload         Json?
  metadata        Json?

  // Source tracking
  source          String?
  correlationId   String?  @map("correlation_id")

  @@index([orchestrationId, timestamp])
  @@index([eventType])
  @@index([timestamp])
  @@index([correlationId])
  @@map("events")
}

/// Checkpoint - State snapshots for resumption
model Checkpoint {
  id              String   @id @default(cuid())
  orchestrationId String   @map("orchestration_id")
  orchestration   Orchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  phase           Phase
  state           Json

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([orchestrationId, createdAt])
  @@map("checkpoints")
}

/// AgentExecution - Track agent invocations
model AgentExecution {
  id              String   @id @default(cuid())
  orchestrationId String   @map("orchestration_id")
  orchestration   Orchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  agentName       String   @map("agent_name")
  model           String?  // opus, sonnet, haiku
  status          AgentStatus @default(RUNNING)

  // Timing
  startedAt       DateTime @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  durationMs      Int?     @map("duration_ms")

  // Execution data
  input           Json?
  result          Json?
  errorType       String?  @map("error_type")
  errorMessage    String?  @map("error_message")

  // Resource tracking
  tokensUsed      Int?     @map("tokens_used")

  @@index([orchestrationId])
  @@index([agentName])
  @@index([status])
  @@index([startedAt])
  @@map("agent_executions")
}

// ============================================================================
// METRICS & ANALYTICS
// ============================================================================

/// AgentMetric - Aggregated performance metrics per agent
model AgentMetric {
  id              String   @id @default(cuid())
  agentName       String   @unique @map("agent_name")

  // Execution stats
  executionCount  Int      @default(0) @map("execution_count")
  successCount    Int      @default(0) @map("success_count")
  failureCount    Int      @default(0) @map("failure_count")

  // Timing stats
  avgDurationMs   Float?   @map("avg_duration_ms")
  p50DurationMs   Float?   @map("p50_duration_ms")
  p95DurationMs   Float?   @map("p95_duration_ms")
  minDurationMs   Float?   @map("min_duration_ms")
  maxDurationMs   Float?   @map("max_duration_ms")

  // Resource usage
  totalTokensUsed BigInt   @default(0) @map("total_tokens_used")
  modelDistribution Json?  @map("model_distribution")

  // Error tracking
  errorTypes      Json?    @map("error_types")

  lastExecutedAt  DateTime? @map("last_executed_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([agentName])
  @@map("agent_metrics")
}

/// OrchestrationMetric - Per-orchestration quality metrics
model OrchestrationMetric {
  id              String   @id @default(cuid())
  orchestrationId String   @map("orchestration_id")
  orchestration   Orchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  phase           Phase?
  metricType      String   @map("metric_type")
  value           Float

  // Quality metrics
  testCoverage    Float?   @map("test_coverage")
  bugCount        Int?     @map("bug_count")
  codeQualityScore Float?  @map("code_quality_score")

  // Cost metrics
  tokensUsed      Int?     @map("tokens_used")
  estimatedCost   Float?   @map("estimated_cost")

  timestamp       DateTime @default(now())
  metadata        Json?

  @@index([orchestrationId])
  @@index([metricType])
  @@index([timestamp])
  @@map("orchestration_metrics")
}

/// SlaDefinition - SLA threshold definitions
model SlaDefinition {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?

  // Thresholds
  targetMs        Int      @map("target_ms")
  warningMs       Int      @map("warning_ms")
  criticalMs      Int      @map("critical_ms")

  // Applicability
  phases          Phase[]
  issueTypes      String[] @map("issue_types")
  priorities      String[]

  enabled         Boolean  @default(true)

  // Relations
  violations      SlaViolation[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("sla_definitions")
}

/// SlaViolation - SLA breach records
model SlaViolation {
  id              String   @id @default(cuid())
  slaId           String   @map("sla_id")
  sla             SlaDefinition @relation(fields: [slaId], references: [id], onDelete: Cascade)

  issueKey        String   @map("issue_key")
  phase           Phase

  actualMs        Int      @map("actual_ms")
  targetMs        Int      @map("target_ms")
  exceededBy      Int      @map("exceeded_by")  // actualMs - targetMs

  severity        SlaViolationSeverity
  acknowledged    Boolean  @default(false)
  acknowledgedBy  String?  @map("acknowledged_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")

  timestamp       DateTime @default(now())
  metadata        Json?

  @@index([slaId])
  @@index([issueKey])
  @@index([severity])
  @@index([timestamp])
  @@map("sla_violations")
}

// ============================================================================
// NOTIFICATIONS & APPROVALS
// ============================================================================

/// Notification - Delivery tracking
model Notification {
  id              String   @id @default(cuid())
  orchestrationId String?  @map("orchestration_id")
  orchestration   Orchestration? @relation(fields: [orchestrationId], references: [id], onDelete: SetNull)

  channel         Channel
  recipient       String

  eventType       String   @map("event_type")
  subject         String?
  body            String?

  status          NotificationStatus @default(PENDING)

  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  readAt          DateTime? @map("read_at")

  retryCount      Int      @default(0) @map("retry_count")
  error           String?

  // Threading
  threadId        String?  @map("thread_id")
  correlationId   String?  @map("correlation_id")

  metadata        Json?

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([orchestrationId])
  @@index([channel])
  @@index([status])
  @@index([sentAt])
  @@map("notifications")
}

/// Approval - Approval workflow tracking
model Approval {
  id              String   @id @default(cuid())
  orchestrationId String   @map("orchestration_id")
  orchestration   Orchestration @relation(fields: [orchestrationId], references: [id], onDelete: Cascade)

  approvalType    String   @map("approval_type")  // pr, release, deployment
  approver        String

  status          ApprovalStatus @default(PENDING)

  requestedAt     DateTime @default(now()) @map("requested_at")
  respondedAt     DateTime? @map("responded_at")

  comment         String?
  metadata        Json?

  @@index([orchestrationId])
  @@index([approver])
  @@index([status])
  @@map("approvals")
}

// ============================================================================
// TEAM & CAPACITY
// ============================================================================

/// Team - Team definitions
model Team {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?

  // Members
  members         Json     // Array of team members with roles

  // Capacity
  capacityHours   Float?   @map("capacity_hours")
  avgVelocity     Float?   @map("avg_velocity")

  // Skills
  skills          Json?    // Skill matrix

  // Constraints
  constraints     Json?    // Working hours, holidays, etc.

  active          Boolean  @default(true)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("teams")
}

/// TeamCapacity - Sprint-level capacity tracking
model TeamCapacity {
  id              String   @id @default(cuid())
  teamId          String   @map("team_id")

  sprintId        String   @map("sprint_id")
  sprintName      String?  @map("sprint_name")

  // Capacity metrics
  totalCapacity   Float    @map("total_capacity")
  allocatedHours  Float    @map("allocated_hours")
  remainingHours  Float    @map("remaining_hours")

  // Velocity
  plannedPoints   Int?     @map("planned_points")
  completedPoints Int?     @map("completed_points")

  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")

  metadata        Json?

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([teamId, sprintId])
  @@index([teamId])
  @@index([sprintId])
  @@map("team_capacity")
}

// ============================================================================
// INTELLIGENCE & LEARNING
// ============================================================================

/// Pattern - Learned patterns from task execution
model Pattern {
  id              String   @id @default(cuid())
  patternType     String   @map("pattern_type")  // decomposition, resolution, etc.
  name            String
  description     String?

  // Pattern data
  signature       Json     // Pattern signature for matching
  template        Json?    // Pattern template

  // Effectiveness
  usageCount      Int      @default(0) @map("usage_count")
  successCount    Int      @default(0) @map("success_count")
  successRate     Float?   @map("success_rate")

  // Applicability
  complexityRange Json?    @map("complexity_range")  // min, max complexity
  issueTypes      String[] @map("issue_types")

  // Examples
  exampleIssues   String[] @map("example_issues")

  active          Boolean  @default(true)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([patternType])
  @@index([successRate])
  @@map("patterns")
}

/// TaskOutcome - Historical task outcomes for learning
model TaskOutcome {
  id              String   @id @default(cuid())
  issueKey        String   @map("issue_key")
  issueType       String   @map("issue_type")

  // Outcome data
  success         Boolean
  durationMs      Int?     @map("duration_ms")

  // Context
  complexity      Float?
  storyPoints     Int?     @map("story_points")
  agentsUsed      String[] @map("agents_used")
  patternsUsed    String[] @map("patterns_used")

  // Quality
  testsPassed     Boolean? @map("tests_passed")
  bugCount        Int?     @map("bug_count")
  reworkCount     Int?     @map("rework_count")

  // Learnings
  learnings       Json?

  timestamp       DateTime @default(now())

  @@index([issueKey])
  @@index([issueType])
  @@index([success])
  @@index([timestamp])
  @@map("task_outcomes")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Phase {
  EXPLORE
  PLAN
  CODE
  TEST
  FIX
  DOCUMENT
}

enum Status {
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum AgentStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum Channel {
  SLACK
  EMAIL
  DISCORD
  TEAMS
  PAGERDUTY
  WEBHOOK
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum SlaViolationSeverity {
  WARNING
  CRITICAL
}

// ============================================================================
// TEMPLATE REGISTRY (claude-code-templating-plugin)
// ============================================================================

/// Template - Core template definition for the template registry
model Template {
  id              String   @id @default(cuid())
  name            String
  version         String
  description     String?

  // Format and source
  format          TemplateFormat
  sourceType      TemplateSourceType @map("source_type")
  sourceLocation  String?  @map("source_location")

  // Categorization
  category        String?
  tags            String[]

  // Authorship
  author          String?
  authorEmail     String?  @map("author_email")

  // Metrics
  downloads       Int      @default(0)
  stars           Int      @default(0)

  // Content
  readme          String?
  variables       Json?    // Template variables schema

  // Visibility
  isPublic        Boolean  @default(true) @map("is_public")
  ownerId         String?  @map("owner_id")

  // Relations
  generations     TemplateGeneration[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([name, version])
  @@index([name])
  @@index([format])
  @@index([category])
  @@index([tags])
  @@map("templates")
}

/// TemplateGeneration - Track template usage and generation metrics
model TemplateGeneration {
  id              String   @id @default(cuid())
  templateId      String   @map("template_id")
  template        Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Generation context
  projectName     String   @map("project_name")
  outputPath      String?  @map("output_path")

  // Variables used
  variables       Json?

  // Execution
  success         Boolean
  durationMs      Int?     @map("duration_ms")
  filesGenerated  Int?     @map("files_generated")

  // Error tracking
  errorType       String?  @map("error_type")
  errorMessage    String?  @map("error_message")

  // User context
  userId          String?  @map("user_id")
  sessionId       String?  @map("session_id")

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([templateId])
  @@index([success])
  @@index([createdAt])
  @@map("template_generations")
}

// Template enums
enum TemplateFormat {
  HANDLEBARS
  COOKIECUTTER
  COPIER
  MAVEN_ARCHETYPE
  HARNESS
}

enum TemplateSourceType {
  EMBEDDED
  LOCAL
  GITHUB
  NPM
  URL
}
