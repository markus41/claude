{
  "$schema": "../schema/config.schema.json",
  "name": "deployment-pipeline",
  "version": "1.0.0",

  "workflow": {
    "type": "state-machine",
    "initialState": "pending",
    "finalStates": ["completed", "failed", "rolled-back"],
    "timeout": "1h"
  },

  "environments": {
    "dev": {
      "order": 1,
      "autoApprove": true,
      "harnessPipeline": "deploy-dev",
      "healthCheckPath": "/health",
      "healthCheckTimeout": "5m"
    },
    "staging": {
      "order": 2,
      "autoApprove": true,
      "harnessPipeline": "deploy-staging",
      "healthCheckPath": "/health",
      "healthCheckTimeout": "5m"
    },
    "prod": {
      "order": 3,
      "autoApprove": false,
      "requireApproval": true,
      "approvers": ["devops-team", "tech-leads"],
      "harnessPipeline": "deploy-prod",
      "healthCheckPath": "/health",
      "healthCheckTimeout": "10m"
    }
  },

  "persistence": {
    "storage": "file",
    "location": ".claude/workflow-state",
    "format": "json",
    "enableBackup": true,
    "maxBackups": 10
  },

  "retry": {
    "maxAttempts": 3,
    "backoffMs": 1000,
    "backoffMultiplier": 2,
    "maxBackoffMs": 30000,
    "retryableStates": ["validating", "building", "testing"],
    "retryableErrors": [
      "ECONNRESET",
      "ETIMEDOUT",
      "ECONNREFUSED",
      "NetworkError",
      "TimeoutError",
      "ServiceUnavailable"
    ]
  },

  "notifications": {
    "enabled": true,
    "channels": ["slack"],
    "events": [
      "pipeline.started",
      "pipeline.approval.required",
      "pipeline.completed",
      "pipeline.failed",
      "pipeline.rollback"
    ],
    "slack": {
      "webhookUrl": "${SLACK_WEBHOOK_URL}",
      "channel": "#deployments",
      "username": "Deployment Bot",
      "iconEmoji": ":rocket:"
    },
    "teams": {
      "webhookUrl": "${TEAMS_WEBHOOK_URL}"
    },
    "email": {
      "enabled": false,
      "smtpHost": "${SMTP_HOST}",
      "smtpPort": 587,
      "from": "deployments@example.com",
      "to": ["devops@example.com"]
    }
  },

  "harness": {
    "accountId": "${HARNESS_ACCOUNT_ID}",
    "orgIdentifier": "${HARNESS_ORG_ID}",
    "projectIdentifier": "${HARNESS_PROJECT_ID}",
    "pipelines": {
      "build": "build-and-push",
      "test": "run-tests",
      "deployDev": "deploy-dev",
      "deployStaging": "deploy-staging",
      "deployProd": "deploy-prod",
      "rollback": "rollback-all"
    }
  },

  "validation": {
    "requireHealthCheck": true,
    "requireResourceLimits": true,
    "requirePDB": true,
    "allowedImageRegistries": [
      "docker.io",
      "ghcr.io",
      "*.azurecr.io"
    ]
  },

  "rollback": {
    "autoRollbackOnFailure": false,
    "rollbackTimeout": "10m",
    "keepFailedPods": true,
    "notifyOnRollback": true
  }
}
