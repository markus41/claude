#!/usr/bin/env node

/**
 * {{pascalCase serverName}} MCP Server
 *
 * {{description}}
 */

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
  {{#if (includes features "resources")}}
  ListResourcesRequestSchema,
  ReadResourceRequestSchema,
  {{/if}}
} from '@modelcontextprotocol/sdk/types.js';

{{#if (eq dataSource "github")}}
import { GitHubClient } from './clients/github.client.js';
{{/if}}
import {
  MCP_TOOLS,
  // Tool handlers will be imported here
} from './tools/index.js';
import type { ServerConfig } from './types/index.js';

// ============================================================================
// Configuration
// ============================================================================

const DEFAULT_CONFIG: ServerConfig = {
  {{#if (eq dataSource "github")}}
  github: {
    owner: '{{#if githubRepo}}{{split githubRepo "/" 0}}{{else}}owner{{/if}}',
    repo: '{{#if githubRepo}}{{split githubRepo "/" 1}}{{else}}repo{{/if}}',
    branch: 'main',
    apiUrl: 'https://api.github.com',
    rawUrl: 'https://raw.githubusercontent.com',
  },
  {{/if}}
  {{#if (includes features "caching")}}
  cache: {
    enabled: true,
    ttl: 3600000, // 1 hour
  },
  {{/if}}
};

// ============================================================================
// Global State
// ============================================================================

let config: ServerConfig = DEFAULT_CONFIG;
{{#if (eq dataSource "github")}}
let githubClient: GitHubClient;
{{/if}}

// ============================================================================
// Initialization
// ============================================================================

/**
 * Initialize clients
 */
function initializeClients(): void {
  {{#if (eq dataSource "github")}}
  githubClient = new GitHubClient(config.github);
  {{/if}}
}

// ============================================================================
// MCP Server Setup
// ============================================================================

/**
 * Create and configure the MCP server
 */
function createServer(): Server {
  const server = new Server(
    {
      name: '{{kebabCase serverName}}',
      version: '1.0.0',
    },
    {
      capabilities: {
        tools: {},
        {{#if (includes features "resources")}}
        resources: {},
        {{/if}}
      },
    }
  );

  // ========================================================================
  // Tool Handlers
  // ========================================================================

  server.setRequestHandler(ListToolsRequestSchema, async () => {
    return {
      tools: MCP_TOOLS,
    };
  });

  server.setRequestHandler(CallToolRequestSchema, async (request) => {
    const { name, arguments: args } = request.params;

    try {
      // Tool handlers will be implemented here
      switch (name) {
        default:
          throw new Error(`Unknown tool: ${name}`);
      }
    } catch (error: any) {
      return {
        content: [
          {
            type: 'text',
            text: JSON.stringify({
              error: true,
              message: error.message,
              details: error.stack,
            }, null, 2),
          },
        ],
        isError: true,
      };
    }
  });

  {{#if (includes features "resources")}}
  // ========================================================================
  // Resource Handlers
  // ========================================================================

  server.setRequestHandler(ListResourcesRequestSchema, async () => {
    return {
      resources: [],
    };
  });

  server.setRequestHandler(ReadResourceRequestSchema, async (request) => {
    const uri = request.params.uri;
    return {
      contents: [
        {
          uri,
          mimeType: 'text/plain',
          text: `Resource: ${uri}`,
        },
      ],
    };
  });
  {{/if}}

  return server;
}

// ============================================================================
// Main Entry Point
// ============================================================================

async function main() {
  // Initialize clients
  initializeClients();

  // Create server
  const server = createServer();

  // Create transport
  const transport = new StdioServerTransport();

  // Connect and start
  await server.connect(transport);

  console.error('╔═══════════════════════════════════════════════════════════════╗');
  console.error('║       {{pascalCase serverName}} MCP Server v1.0.0                      ║');
  console.error('║                                                               ║');
  console.error('║  MCP Server running on stdio - Ready for Claude requests   ║');
  console.error('╚═══════════════════════════════════════════════════════════════╝');
}

main().catch((error) => {
  console.error('Fatal error:', error);
  process.exit(1);
});
