{
  "$schema": "../../core/schemas/plugin.schema.json",
  "name": "database-schema-designer",
  "displayName": "Database Schema Designer",
  "callsign": "Architect",
  "faction": "Forerunner",
  "version": "1.0.0",
  "description": "Architect - Master builder of data structures. Orchestrates production-grade database schema design, optimization, and evolution. Detects N+1 queries, suggests optimal indexes, plans zero-downtime migrations, and ensures schemas perform at scale. Real value for real databases.",
  "author": {
    "name": "The Lobbi",
    "email": "developers@thelobbi.io"
  },
  "license": "MIT",
  "repository": "https://github.com/Lobbi-Docs/claude",
  "categories": ["database", "backend", "devops", "performance"],
  "keywords": [
    "database", "schema", "migration", "prisma", "typeorm", "alembic",
    "sql", "postgres", "mysql", "mongodb", "index", "optimization",
    "n+1", "query", "performance", "erd", "diagram", "normalization",
    "zero-downtime", "backward-compatible", "seed-data", "fixtures",
    "foreign-key", "constraint", "trigger", "view", "materialized-view",
    "partition", "sharding", "replication", "backup", "restore"
  ],

  "provides": {
    "commands": 15,
    "agents": 10,
    "skills": 6,
    "hooks": 5
  },

  "databases": {
    "relational": {
      "postgres": {
        "orms": ["prisma", "typeorm", "sequelize", "knex", "drizzle"],
        "migrations": ["prisma", "typeorm", "alembic", "knex", "flyway", "liquibase"],
        "features": ["jsonb", "arrays", "full-text-search", "partitioning", "replication"]
      },
      "mysql": {
        "orms": ["prisma", "typeorm", "sequelize", "knex"],
        "migrations": ["prisma", "typeorm", "knex", "flyway", "liquibase"],
        "features": ["json", "full-text-search", "replication", "sharding"]
      },
      "sqlite": {
        "orms": ["prisma", "typeorm", "sequelize", "knex"],
        "migrations": ["prisma", "typeorm", "knex"],
        "features": ["fts5", "json1", "embedded"]
      }
    },
    "nosql": {
      "mongodb": {
        "orms": ["mongoose", "prisma", "typegoose"],
        "migrations": ["migrate-mongo", "umzug"],
        "features": ["aggregation", "sharding", "replication", "atlas-search"]
      },
      "dynamodb": {
        "orms": ["dynamoose", "electrodb"],
        "patterns": ["single-table-design", "gsi-overloading"],
        "features": ["streams", "dax", "global-tables"]
      }
    }
  },

  "optimizationCapabilities": {
    "queryAnalysis": {
      "n1Detection": {
        "description": "Detects N+1 query patterns in code and ORM queries",
        "strategies": ["eager-loading", "select-n1", "dataloaders", "batch-loading"],
        "tools": ["prisma-query-analyzer", "typeorm-logging", "pg-stat-statements"]
      },
      "slowQueryDetection": {
        "description": "Identifies slow queries and suggests optimizations",
        "thresholds": {
          "warning": "100ms",
          "critical": "1000ms"
        },
        "tools": ["pg_stat_statements", "mysql-slow-query-log", "explain-analyze"]
      },
      "indexSuggestions": {
        "description": "Analyzes queries and suggests optimal indexes",
        "types": ["btree", "hash", "gin", "gist", "brin", "composite", "partial", "covering"],
        "considerations": ["query-patterns", "write-overhead", "storage-cost", "selectivity"]
      }
    },
    "schemaDesign": {
      "normalization": {
        "levels": ["1nf", "2nf", "3nf", "bcnf"],
        "denormalization": {
          "when": "read-heavy workloads with proven performance issues",
          "patterns": ["materialized-views", "computed-columns", "redundant-data"]
        }
      },
      "dataTypes": {
        "optimization": true,
        "rightSizing": true,
        "examples": {
          "timestamps": "Use timestamptz over varchar for dates",
          "enums": "Use enum types over varchar for fixed values",
          "numeric": "Use integer over numeric for whole numbers",
          "text": "Use text over varchar unless length constraint needed"
        }
      },
      "constraints": {
        "types": ["primary-key", "foreign-key", "unique", "check", "not-null"],
        "enforcement": "database-level",
        "validation": "application-level-plus-db"
      }
    },
    "migrationStrategies": {
      "zeroDowntime": {
        "description": "Plan migrations with zero downtime",
        "patterns": [
          "expand-contract",
          "dual-writes",
          "shadow-columns",
          "feature-flags",
          "gradual-rollout"
        ],
        "phases": ["expand", "migrate", "contract"]
      },
      "backwardCompatible": {
        "description": "Ensure migrations are backward compatible",
        "rules": [
          "Add columns as nullable or with defaults",
          "Never rename columns directly (add new, dual-write, remove old)",
          "Drop columns in separate deployment after code removal",
          "Use views for column renames during transition"
        ]
      },
      "dataMigration": {
        "description": "Handle data transformation during schema changes",
        "strategies": ["backfill-scripts", "triggers", "stored-procedures", "batch-updates"],
        "safetyChecks": ["dry-run", "rollback-plan", "data-validation", "checkpoints"]
      }
    }
  },

  "orchestration": {
    "enabled": true,
    "mandatory": true,
    "protocol": {
      "version": "2.0.0",
      "minSubAgents": 3,
      "maxSubAgents": 10,
      "defaultSubAgents": 6
    },
    "designFlow": {
      "phases": [
        {
          "id": "requirements-analysis",
          "name": "Requirements Analysis",
          "agents": ["requirements-analyzer-agent", "entity-modeler-agent"],
          "parallel": false,
          "required": true
        },
        {
          "id": "schema-design",
          "name": "Schema Design",
          "agents": ["schema-architect-agent", "normalization-agent"],
          "parallel": true,
          "required": true
        },
        {
          "id": "optimization",
          "name": "Performance Optimization",
          "agents": ["index-optimizer-agent", "query-analyzer-agent"],
          "parallel": true,
          "required": true
        },
        {
          "id": "migration-planning",
          "name": "Migration Planning",
          "agents": ["migration-strategist-agent", "zero-downtime-planner-agent"],
          "parallel": false,
          "required": true
        },
        {
          "id": "validation",
          "name": "Validation & Testing",
          "agents": ["migration-validator-agent", "seed-generator-agent"],
          "parallel": true,
          "required": true
        },
        {
          "id": "documentation",
          "name": "Documentation",
          "agents": ["erd-generator-agent"],
          "parallel": false,
          "required": true
        }
      ]
    }
  },

  "commands": {
    "schema:design": "commands/schema-design.md",
    "schema:analyze": "commands/schema-analyze.md",
    "schema:optimize": "commands/schema-optimize.md",
    "schema:migrate": "commands/schema-migrate.md",
    "schema:rollback": "commands/schema-rollback.md",
    "query:analyze": "commands/query-analyze.md",
    "query:optimize": "commands/query-optimize.md",
    "index:suggest": "commands/index-suggest.md",
    "index:analyze": "commands/index-analyze.md",
    "migration:generate": "commands/migration-generate.md",
    "migration:plan-zero-downtime": "commands/migration-plan-zero-downtime.md",
    "seed:generate": "commands/seed-generate.md",
    "erd:generate": "commands/erd-generate.md",
    "n1:detect": "commands/n1-detect.md",
    "schema:validate": "commands/schema-validate.md"
  },

  "agents": {
    "requirements-analyzer-agent": {
      "path": "agents/requirements-analyzer-agent.md",
      "model": "sonnet",
      "description": "Analyzes feature requirements and extracts data modeling needs",
      "triggers": ["design schema for", "data model for", "database for feature"]
    },
    "schema-architect-agent": {
      "path": "agents/schema-architect-agent.md",
      "model": "opus",
      "description": "Master architect that designs production-ready schemas with performance in mind",
      "triggers": ["design schema", "create schema", "database design", "data architecture"]
    },
    "entity-modeler-agent": {
      "path": "agents/entity-modeler-agent.md",
      "model": "sonnet",
      "description": "Identifies entities, relationships, and cardinalities from requirements",
      "triggers": ["entities", "relationships", "erd", "data model"]
    },
    "normalization-agent": {
      "path": "agents/normalization-agent.md",
      "model": "sonnet",
      "description": "Applies normalization principles and suggests strategic denormalization",
      "triggers": ["normalize", "normalization", "3nf", "denormalize"]
    },
    "index-optimizer-agent": {
      "path": "agents/index-optimizer-agent.md",
      "model": "sonnet",
      "description": "Analyzes query patterns and suggests optimal indexes for performance",
      "triggers": ["index", "slow query", "optimize query", "performance"]
    },
    "query-analyzer-agent": {
      "path": "agents/query-analyzer-agent.md",
      "model": "sonnet",
      "description": "Detects N+1 queries, analyzes query plans, and suggests optimizations",
      "triggers": ["n+1", "query performance", "slow query", "explain plan"]
    },
    "migration-strategist-agent": {
      "path": "agents/migration-strategist-agent.md",
      "model": "opus",
      "description": "Plans complex migrations with rollback strategies and risk assessment",
      "triggers": ["migration", "schema change", "alter table", "migrate"]
    },
    "zero-downtime-planner-agent": {
      "path": "agents/zero-downtime-planner-agent.md",
      "model": "opus",
      "description": "Plans zero-downtime migrations using expand-contract and dual-write patterns",
      "triggers": ["zero downtime", "no downtime", "online migration", "live migration"]
    },
    "migration-validator-agent": {
      "path": "agents/migration-validator-agent.md",
      "model": "sonnet",
      "description": "Validates migrations for safety, backward compatibility, and data integrity",
      "triggers": ["validate migration", "check migration", "migration safety"]
    },
    "seed-generator-agent": {
      "path": "agents/seed-generator-agent.md",
      "model": "haiku",
      "description": "Generates realistic seed data and test fixtures for database testing",
      "triggers": ["seed data", "test data", "fixtures", "sample data"]
    },
    "erd-generator-agent": {
      "path": "agents/erd-generator-agent.md",
      "model": "haiku",
      "description": "Generates ERD diagrams in Mermaid, PlantUML, or dbdiagram.io format",
      "triggers": ["erd", "diagram", "visualize schema", "schema diagram"]
    }
  },

  "skills": {
    "schema-design": {
      "path": "skills/schema-design.md",
      "description": "Database schema design patterns, normalization, and best practices",
      "triggers": ["schema design", "database design", "data modeling"]
    },
    "migration-management": {
      "path": "skills/migration-management.md",
      "description": "Prisma, TypeORM, Alembic, and Flyway migration strategies",
      "triggers": ["migration", "prisma migrate", "typeorm migration", "alembic"]
    },
    "query-optimization": {
      "path": "skills/query-optimization.md",
      "description": "Query optimization, EXPLAIN plans, index strategies, N+1 detection",
      "triggers": ["query optimization", "slow query", "explain plan", "n+1"]
    },
    "zero-downtime-migrations": {
      "path": "skills/zero-downtime-migrations.md",
      "description": "Zero-downtime migration patterns: expand-contract, dual-writes, feature flags",
      "triggers": ["zero downtime", "online migration", "expand contract"]
    },
    "indexing-strategies": {
      "path": "skills/indexing-strategies.md",
      "description": "B-tree, hash, GIN, GiST, partial, covering, and composite indexes",
      "triggers": ["index", "indexing", "composite index", "partial index"]
    },
    "seed-data-generation": {
      "path": "skills/seed-data-generation.md",
      "description": "Realistic seed data generation using Faker, factories, and builders",
      "triggers": ["seed", "fixtures", "test data", "faker"]
    }
  },

  "hooks": {
    "preSchemaChange": {
      "script": "hooks/scripts/pre-schema-change.sh",
      "description": "Validates schema changes before applying"
    },
    "postSchemaChange": {
      "script": "hooks/scripts/post-schema-change.sh",
      "description": "Generates migration and updates documentation"
    },
    "preMigration": {
      "script": "hooks/scripts/pre-migration.sh",
      "description": "Validates migration safety and creates backup point"
    },
    "postMigration": {
      "script": "hooks/scripts/post-migration.sh",
      "description": "Validates data integrity and updates schema documentation"
    },
    "onSlowQuery": {
      "script": "hooks/scripts/on-slow-query.sh",
      "description": "Triggers when slow query is detected, suggests optimizations"
    }
  },

  "permissions": {
    "filesystem": [
      { "path": "**/prisma/**", "access": "readwrite" },
      { "path": "**/migrations/**", "access": "readwrite" },
      { "path": "**/seeds/**", "access": "readwrite" },
      { "path": "**/schema.prisma", "access": "readwrite" },
      { "path": "**/ormconfig.*", "access": "readwrite" },
      { "path": "**/alembic.ini", "access": "readwrite" },
      { "path": "**/knexfile.*", "access": "readwrite" }
    ],
    "tools": ["Bash", "Read", "Write", "Edit", "Grep", "Glob", "Task"],
    "mcpServers": ["supabase", "mongodb"]
  },

  "configuration": {
    "schema": {
      "type": "object",
      "properties": {
        "database": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["postgres", "mysql", "sqlite", "mongodb", "dynamodb"],
              "default": "postgres"
            },
            "orm": {
              "type": "string",
              "enum": ["prisma", "typeorm", "sequelize", "knex", "mongoose", "drizzle"],
              "default": "prisma"
            }
          }
        },
        "optimization": {
          "type": "object",
          "properties": {
            "slowQueryThreshold": {
              "type": "number",
              "default": 100,
              "description": "Slow query threshold in milliseconds"
            },
            "enableN1Detection": {
              "type": "boolean",
              "default": true
            },
            "autoSuggestIndexes": {
              "type": "boolean",
              "default": true
            }
          }
        },
        "migrations": {
          "type": "object",
          "properties": {
            "requireZeroDowntime": {
              "type": "boolean",
              "default": true
            },
            "requireBackwardCompatible": {
              "type": "boolean",
              "default": true
            },
            "autoGenerateSeed": {
              "type": "boolean",
              "default": true
            },
            "autoGenerateERD": {
              "type": "boolean",
              "default": true
            }
          }
        },
        "validation": {
          "type": "object",
          "properties": {
            "requireForeignKeys": {
              "type": "boolean",
              "default": true
            },
            "requireIndexesOnForeignKeys": {
              "type": "boolean",
              "default": true
            },
            "warnOnMissingIndexes": {
              "type": "boolean",
              "default": true
            }
          }
        }
      }
    }
  },

  "activation": {
    "auto": true,
    "priority": 850,
    "conditions": {
      "filePatterns": [
        "**/prisma/schema.prisma",
        "**/migrations/**",
        "**/seeds/**",
        "**/ormconfig.*",
        "**/alembic/**",
        "**/knexfile.*"
      ],
      "keywords": [
        "schema",
        "migration",
        "database",
        "prisma",
        "typeorm",
        "n+1",
        "index",
        "query"
      ]
    }
  }
}
